<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teacher Dashboard</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
    body{font-family:Arial,sans-serif;background:#f6f0e8;padding:20px;text-align:center;}
    h1{letter-spacing:2px;margin-bottom:20px;}
    .section-box{display:inline-block;padding:15px 30px;border:3px solid black;border-radius:15px;font-size:24px;margin-bottom:40px;background:white;}
    #scanner-box{width:300px;height:300px;border:3px solid black;border-radius:15px;margin:auto;margin-bottom:20px;background:white;}
    table{width:95%;margin:auto;border-collapse:collapse;margin-top:20px;}
    th{background:#19f510;padding:8px;font-size:14px;border:1px solid black;}
    td{padding:6px;border:1px solid black;background:white;font-size:14px;}
    #status{margin-top:15px;font-size:16px;font-weight:bold;padding:10px;}
    .ok{ color:green; } .err{ color:red; } .warn{ color:#b8860b; }
    .month-btn{padding:6px 10px;margin:2px;border-radius:6px;border:2px solid black;background:#2be632;font-weight:700;cursor:pointer;}
    th.sticky, td.sticky{position:sticky;left:0;background:#fff; z-index:2;}
    th.sticky{z-index:3;}
</style>
</head>
<body>

<h1>TEACHER DASHBOARD</h1>
<div class="section-box">BSIT–2C</div>
<h2>Attendance Scanner</h2>
<div id="scanner-box"></div>
<div id="status" class="warn">Scan a student's QR code…</div>

<div style="margin:20px 0;">
    <strong>View Monthly Attendance:</strong>
    <button class="month-btn" data-month="all">All Months</button>
    <button class="month-btn" data-month="8">Aug</button>
    <button class="month-btn" data-month="9">Sep</button>
    <button class="month-btn" data-month="10">Oct</button>
    <button class="month-btn" data-month="11">Nov</button>
    <button class="month-btn" data-month="12">Dec</button>
</div>

<div id="attendanceTables"></div>

<script>
// ---------------- STUDENTS ----------------
const students = [
    {name:"Pinuela, Britney Ashley C.", id:"242680"},
    {name:"De Asis, Keniel Drew D.", id:"244556"},
    {name:"Ubas, Mar Julius B.", id:"241156"},
    {name:"Tomacas, Jules Ian C.", id:"240475"},
    {name:"Espelimbergo, JericaMae B.", id:"241804"},
    {name:"Ampuan, Richelle C.", id:"244437"},
    {name:"Olchondra, Chrisnel D.", id:"244647"},
    {name:"Obrino, Mark O.", id:"243008"},
    {name:"Lovino, Carl Joseph T.", id:"242288"},
    {name:"Gabito, Rhea D.", id:"244872"},
    {name:"Parras, Christian Paul E.", id:"244574"},
    {name:"Bido, Zanjoe M.", id:"242905"},
    {name:"Pelembergo, Paul Zairosh", id:"243191"},
    {name:"Adrayan, Rey-an A.", id:"241666"},
    {name:"Arce, Rowecker Brent", id:"243364"},
    {name:"Kent Cedrick O. Celajes", id:"245866"},
    {name:"Kent Jeanne S. De Leon", id:"235828"},
    {name:"Raizalyn Omela", id:"243644"},
    {name:"Corong, Jasthen M.", id:"241649"},
    {name:"Cardeño, Jose Manuel M.", id:"240456"},
    {name:"Magdaraog, Dranreb D.", id:"240439"},
    {name:"Martinico, Maris D.", id:"241096"},
    {name:"Formaran, John Francis C.", id:"241661"}
];

// ---------------- ATTENDANCE STORAGE ----------------
let attendance = JSON.parse(localStorage.getItem("attendance")) || {};
const today = new Date();
const todayKey = today.toISOString().split('T')[0];

// Initialize attendance structure
students.forEach(s=>{
    if(!attendance[s.id]) attendance[s.id]={};
    for(let m=8;m<=12;m++){
        if(!attendance[s.id][m]) attendance[s.id][m]={records:{}};
    }
});
localStorage.setItem("attendance", JSON.stringify(attendance));

// ---------------- RENDER TABLES ----------------
function daysInMonth(month, year){ return new Date(year, month, 0).getDate(); }

function renderTables(filterMonth="all"){
    const container = document.getElementById("attendanceTables");
    container.innerHTML="";
    const year = today.getFullYear();
    const monthsName = ["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    
    function renderMonth(m){
        const totalDays = daysInMonth(m, year);
        let html=`<h3>${monthsName[m]} ${year}</h3><table><tr><th class="sticky">Name</th>`;
        
        const weekdays = [];
        for(let d=1; d<=totalDays; d++){
            const dateObj = new Date(year,m-1,d);
            const day = dateObj.getDay();
            if(day!==0 && day!==6){ // skip Sunday and Saturday
                weekdays.push(d);
                html+=`<th>${d}</th>`;
            }
        }
        html+=`<th>Total P</th><th>Total A</th></tr>`;
        
        students.forEach(s=>{
            let tr=`<tr><td class="sticky">${s.name}</td>`;
            let present=0, absent=0;
            weekdays.forEach(d=>{
                const key = `${year}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const val = attendance[s.id][m].records[key] ? "P":"A";
                if(val==="P") present++; else absent++;
                tr+=`<td>${val}</td>`;
            });
            tr+=`<td>${present}</td><td>${absent}</td></tr>`;
            html+=tr;
        });
        html+="</table>";
        container.innerHTML+=html;
    }

    if(filterMonth==="all"){
        for(let m=8;m<=12;m++) renderMonth(m);
    } else {
        renderMonth(parseInt(filterMonth));
    }
}

renderTables("all");

// ---------------- QR SCANNER (continuous multiple scans) ----------------
function onScanSuccess(decodedText){
    try{
        const data = JSON.parse(decodedText);
        const student = students.find(s=>s.id===data.id);
        if(!student){
            document.getElementById("status").innerHTML="<span class='err'>❌ Unknown QR Code</span>";
            return;
        }
        const month = today.getMonth()+1;
        // Only mark present once per student per day
        if(!attendance[student.id][month].records[todayKey]){
            attendance[student.id][month].records[todayKey] = true;
            localStorage.setItem("attendance", JSON.stringify(attendance));
            renderTables(document.querySelector(".month-btn.active")?.dataset.month || "all");
            document.getElementById("status").innerHTML=`<span class='ok'>✔ Marked Present: ${student.name}</span>`;
        } else {
            document.getElementById("status").innerHTML=`<span class='warn'>⚠ Already Marked: ${student.name}</span>`;
        }
    } catch(e){
        document.getElementById("status").innerHTML="<span class='err'>Invalid QR Format</span>";
    }
}

// ---------------- START SCANNER ----------------
let scanner = new Html5Qrcode("scanner-box");
Html5Qrcode.getCameras().then(devices=>{
    if(devices.length>0){
        scanner.start(devices[0].id, { fps:10, qrbox:250 }, onScanSuccess)
            .catch(err => console.error("Scanner failed to start:", err));
    }
});

// ---------------- MONTH BUTTONS ----------------
document.querySelectorAll(".month-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
        document.querySelectorAll(".month-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        renderTables(btn.dataset.month);
    });
});
</script>

</body>
</html>
